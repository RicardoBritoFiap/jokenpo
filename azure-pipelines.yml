# Docker
# Build a Docker image
# https://docs.microsoft.com/azure/devops/pipelines/languages/docker

trigger:
- main

resources:
- repo: self

variables:
  tag: '$(Build.BuildId)'
  webAppName: 'cp3rm98370'
  environmentName: 'cp3rm98370'
  vmImageName: 'ubuntu-latest'


stages:
- stage: Build
  displayName: Build image
  jobs:
  - job: Build
    displayName: Build
    pool:
      vmImage: ubuntu-latest
    steps:
    - task: Docker@2
      displayName: Build an image
      inputs:
        command: build
        dockerfile: '$(Build.SourcesDirectory)/Dockerfile'
        tags: |
          $(tag)


- stage: Deploy
  displayName: Deploy stage
  dependsOn: Build
  condition: succeeded()
  jobs:
  - deployment: DeployWebApp
    displayName: Deploy Web App
    environment: $(environmentName)
    pool:
      vmImage: $(vmImageName)
    strategy:
      runOnce:
        deploy:
          steps:
          - script: |
              echo "Listing contents of $(Pipeline.Workspace)"
              ls -R $(Pipeline.Workspace)
              echo "Listing contents of $(System.DefaultWorkingDirectory)"
              ls -R $(System.DefaultWorkingDirectory)
            displayName: 'Debug: List artifact paths'
          
          - task: AzureWebApp@1
            displayName: 'Azure Web App Deploy'
            inputs:
              azureSubscription: 'Azure for Students (6b3f65f8-c627-4389-9b18-4e2623914819)'
              appType: webAppLinux
              appName: $(webAppName)
              package: '$(Pipeline.Workspace)/drop/netxai-0.0.1-SNAPSHOT.jar'
